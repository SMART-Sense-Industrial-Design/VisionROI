<!DOCTYPE html>
<html>
<head>
    <title>Inference with ROI</title>
</head>
<body>
    <h2>Inference with Saved ROI</h2>
    <input id="cameraSource" placeholder="Camera source">
    <button id="startButton">Load ROI & Start Stream</button>
    <p id="status"></p>
    <div style="position: relative; display: inline-block;">
        <img id="video" width="640" height="480" />
        <canvas id="canvas" width="640" height="480" style="position: absolute; left: 0; top: 0;"></canvas>
    </div>

    <script>
        let socket;
        let rois = [];
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        document.getElementById("startButton").onclick = loadAndStart;

        async function loadAndStart() {
            const source = document.getElementById("cameraSource").value;
            const camRes = await fetch("/set_camera", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({source})
            });
            if (!camRes.ok) {
                document.getElementById("status").innerText = "Camera error";
                return;
            }

            const res = await fetch("/load_roi");
            const data = await res.json();
            document.getElementById("status").innerText = "Loaded: " + data.filename;
            rois = data.rois;

            socket = new WebSocket("ws://" + location.host + "/ws");
            socket.onmessage = function(event) {
                video.src = 'data:image/jpeg;base64,' + event.data;
            };
        }

        // รอให้ภาพกล้องแสดงก่อน แล้ววาดกรอบ ROI ซ้อนบน canvas
        video.onload = () => {
            canvas.width = video.width;
            canvas.height = video.height;
            drawRois();
        };

        function drawRois() {
            requestAnimationFrame(drawRois);  // เรียกวนต่อเนื่อง
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = 'lime';
            ctx.lineWidth = 2;
            ctx.font = "14px Arial";
            ctx.fillStyle = 'yellow';
            rois.forEach((r, i) => {
                ctx.beginPath();
                ctx.rect(r.x, r.y, r.width, r.height);
                ctx.stroke();
                ctx.fillText("ROI " + (i + 1), r.x + 5, r.y + 15);
            });
        }
    </script>
</body>
</html>
