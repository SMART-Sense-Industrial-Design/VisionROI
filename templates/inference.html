<!DOCTYPE html>
<html>
<head>
    <title>Inference with ROI</title>
</head>
<body>
    <h2>Inference with Saved ROI</h2>
    <select id="sourceSelect"></select>
    <button id="startButton">Start</button>
    <button id="stopButton" disabled>Stop</button>
    <p id="status"></p>
    <div style="position: relative; display: inline-block;">
        <img id="video" width="640" height="480" />
        <canvas id="canvas" width="640" height="480" style="position: absolute; left: 0; top: 0;"></canvas>
    </div>

    <script>
        let socket;
        let rois = [];
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const startButton = document.getElementById("startButton");
        const stopButton = document.getElementById("stopButton");
        const statusEl = document.getElementById("status");

        startButton.onclick = startInference;
        stopButton.onclick = stopInference;

        async function loadSources() {
            const res = await fetch("/sources");
            const data = await res.json();
            const select = document.getElementById("sourceSelect");
            data.forEach(name => {
                const opt = document.createElement("option");
                opt.value = name;
                opt.textContent = name;
                select.appendChild(opt);
            });
        }

        loadSources();

        async function startInference() {
            const name = document.getElementById("sourceSelect").value;
            if (!name) {
                statusEl.innerText = "Select source first";
                return;
            }
            const cfg = await fetch(`/source_config?name=${encodeURIComponent(name)}`).then(r => r.json());
            const camRes = await fetch("/set_camera", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ source: cfg.source })
            });
            if (!camRes.ok) {
                statusEl.innerText = "Camera error";
                return;
            }

            const res = await fetch("/load_roi");
            const data = await res.json();
            statusEl.innerText = "Loaded: " + data.filename;
            rois = data.rois;

            const startRes = await fetch("/start_inference", { method: "POST" });
            const startData = await startRes.json();
            if (startData.status === "started" || startData.status === "already_running") {
                openSocket();
                setRunningUI();
            }
        }

        async function stopInference() {
            await fetch("/stop_inference", { method: "POST" });
            if (socket) {
                socket.close();
                socket = null;
            }
            statusEl.innerText = "Stopped";
            startButton.innerText = "Resume";
            startButton.disabled = false;
            stopButton.disabled = true;
        }

        function openSocket() {
            socket = new WebSocket("ws://" + location.host + "/ws");
            socket.onmessage = function(event) {
                video.src = 'data:image/jpeg;base64,' + event.data;
            };
        }

        async function checkStatus() {
            const res = await fetch("/inference_status");
            const data = await res.json();
            if (data.running) {
                const roiRes = await fetch("/load_roi");
                const roiData = await roiRes.json();
                rois = roiData.rois;
                openSocket();
                setRunningUI();
            } else {
                statusEl.innerText = "Idle";
                startButton.innerText = "Start";
                startButton.disabled = false;
                stopButton.disabled = true;
            }
        }

        function setRunningUI() {
            statusEl.innerText = "Running";
            startButton.disabled = true;
            stopButton.disabled = false;
            startButton.innerText = "Start";
        }

        // ตรวจสอบสถานะ inference เมื่อหน้าเพจโหลด
        window.addEventListener('load', checkStatus);

        // รอให้ภาพกล้องแสดงก่อน แล้ววาดกรอบ ROI ซ้อนบน canvas
        video.onload = () => {
            canvas.width = video.width;
            canvas.height = video.height;
            drawRois();
        };

        function drawRois() {
            requestAnimationFrame(drawRois);  // เรียกวนต่อเนื่อง
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = 'lime';
            ctx.lineWidth = 2;
            ctx.font = "14px Arial";
            ctx.fillStyle = 'yellow';
            rois.forEach((r, i) => {
                ctx.beginPath();
                ctx.rect(r.x, r.y, r.width, r.height);
                ctx.stroke();
                ctx.fillText("ROI " + (i + 1), r.x + 5, r.y + 15);
            });
        }
    </script>
</body>
</html>
