{% extends "base.html" %}
{% block title %}Create Source{% endblock %}
{% block content %}

<style>
    table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 20px;
    }
    th, td {
        border: 1px solid #ccc;
        padding: 8px;
    }
    th {
        background-color: #f0f0f0;
    }
    button.delete {
        background-color: #e74c3c;
        color: #fff;
        border: none;
        padding: 6px 12px;
        cursor: pointer;
    }
</style>

<h2>Create Source</h2>

<div id="status-message"></div>
<form method="POST" action="/create_source">
    <div>
        <label for="name">Name:</label>
        <input type="text" id="name" name="name" required>
    </div>
    <div>
        <label for="source">Source:</label>
        <input type="text" id="source" name="source" required>
    </div>
    <button type="submit">Create</button>
</form>

<h3>Source List</h3>
<table>
    <thead>
        <tr>
            <th>Name</th>
            <th>Source</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="source-table-body">
    </tbody>
</table>

<script>
    const messageEl = document.getElementById('status-message');

    async function fetchWithStatus(url, options = {}) {
        messageEl.textContent = 'กำลังโหลด...';
        try {
            const res = await fetch(url, options);
            if (!res.ok) throw new Error('network');
            messageEl.textContent = 'สำเร็จ';
            return res;
        } catch (err) {
            messageEl.textContent = 'เกิดข้อผิดพลาด';
            throw err;
        }
    }

    async function loadSources() {
        try {
            const resp = await fetchWithStatus('/source_list');
            const data = await resp.json();
            const tbody = document.getElementById('source-table-body');
            tbody.innerHTML = '';
            data.forEach(src => {
                const tr = document.createElement('tr');
                const nameTd = document.createElement('td');
                nameTd.textContent = src.name;
                const sourceTd = document.createElement('td');
                sourceTd.textContent = src.source;
                const actionTd = document.createElement('td');
                const delBtn = document.createElement('button');
                delBtn.textContent = 'Delete';
                delBtn.classList.add('delete');
                delBtn.addEventListener('click', async () => {
                    if (confirm(`Delete ${src.name}?`)) {
                        try {
                            await fetchWithStatus(`/delete_source/${encodeURIComponent(src.name)}`, { method: 'DELETE' });
                            await loadSources();
                        } catch (err) {
                            /* error handled in fetchWithStatus */
                        }
                    }
                });
                actionTd.appendChild(delBtn);
                tr.appendChild(nameTd);
                tr.appendChild(sourceTd);
                tr.appendChild(actionTd);
                tbody.appendChild(tr);
            });
        } catch (err) {
            console.error('Failed to load sources', err);
        }
    }
    loadSources();

</script>
{% endblock %}
