{% extends "base.html" %}
{% block title %}Create Source{% endblock %}
{% block content %}

<h2>Create Source</h2>

<form id="create-form" method="POST" action="/create_source">
    <div class="mb-3">
        <label for="name" class="form-label">Name:</label>
        <input type="text" id="name" name="name" class="form-control" required>
    </div>
    <div class="mb-3">
        <label for="source" class="form-label">Source:</label>
        <input type="text" id="source" name="source" class="form-control" required>
    </div>
    <div class="mb-3 d-flex gap-3">
        <div class="d-flex align-items-center">
            <label class="me-2 mb-0">
                <input type="checkbox" id="width-toggle"> Width:
            </label>
            <input type="number" id="width" name="width" class="form-control" style="max-width:150px;" disabled>
        </div>
        <div class="d-flex align-items-center">
            <label class="me-2 mb-0">
                <input type="checkbox" id="height-toggle"> Height:
            </label>
            <input type="number" id="height" name="height" class="form-control" style="max-width:150px;" disabled>
        </div>
    </div>
    <button type="submit" class="btn btn-primary">Create</button>
</form>

<h3>Source List</h3>
<table class="table table-bordered mt-3">
    <thead>
        <tr>
            <th>Name</th>
            <th>Source</th>
            <th>Width</th>
            <th>Height</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="source-table-body">
    </tbody>
</table>

<script>
    const widthToggle = document.getElementById('width-toggle');
    const widthInput = document.getElementById('width');
    widthToggle.addEventListener('change', (e) => {
        widthInput.disabled = !e.target.checked;
        if (!e.target.checked) widthInput.value = '';
    });
    const heightToggle = document.getElementById('height-toggle');
    const heightInput = document.getElementById('height');
    heightToggle.addEventListener('change', (e) => {
        heightInput.disabled = !e.target.checked;
        if (!e.target.checked) heightInput.value = '';
    });

    async function loadSources() {
        try {
            const resp = await fetch('/source_list');
            if (!resp.ok) throw new Error('network');
            const data = await resp.json();
            const tbody = document.getElementById('source-table-body');
            tbody.innerHTML = '';
            data.forEach(src => {
                const tr = document.createElement('tr');
                const nameTd = document.createElement('td');
                nameTd.textContent = src.name;
                const sourceTd = document.createElement('td');
                sourceTd.textContent = src.source;
                const widthTd = document.createElement('td');
                widthTd.textContent = src.width ?? '';
                const heightTd = document.createElement('td');
                heightTd.textContent = src.height ?? '';
                const actionTd = document.createElement('td');
                const delBtn = document.createElement('button');
                delBtn.textContent = 'Delete';
                delBtn.className = 'btn btn-danger btn-sm';
                delBtn.addEventListener('click', async () => {
                    if (confirm(`Delete ${src.name}?`)) {
                        try {
                            const delRes = await fetch(`/delete_source/${encodeURIComponent(src.name)}`, { method: 'DELETE' });
                            if (!delRes.ok) throw new Error('network');
                            showAlert('Source deleted', 'success');
                            await loadSources();
                        } catch (err) {
                            showAlert('Delete failed', 'error');
                        }
                    }
                });
                actionTd.appendChild(delBtn);
                tr.appendChild(nameTd);
                tr.appendChild(sourceTd);
                tr.appendChild(widthTd);
                tr.appendChild(heightTd);
                tr.appendChild(actionTd);
                tbody.appendChild(tr);
            });
            showAlert('Sources loaded', 'success');
        } catch (err) {
            console.error('Failed to load sources', err);
            showAlert('Failed to load sources', 'error');
        }
    }

    document.getElementById('create-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        try {
            const res = await fetch('/create_source', { method: 'POST', body: formData });
            const data = await res.json();
            if (res.ok && data.status === 'created') {
                showAlert('Source created', 'success');
                e.target.reset();
                widthInput.disabled = true;
                heightInput.disabled = true;
                await loadSources();
            } else {
                showAlert(data.message || 'Create failed', 'error');
            }
        } catch (err) {
            showAlert('Create failed', 'error');
        }
    });

    loadSources();

</script>
{% endblock %}
