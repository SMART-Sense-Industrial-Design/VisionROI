{% extends "base.html" %}
{% block title %}สร้างแหล่งวิดีโอ{% endblock %}
{% block content %}

<div class="container py-4">
  
  <form id="create-form" method="POST" action="/create_source" class="card mb-4">
    <div class="card-header">
      <h2>สร้างแหล่งวิดีโอ</h2>
    </div>
    <div class="card-body">
    <div class="mb-3">
      <label for="name" class="form-label">ชื่อ:</label>
      <input type="text" id="name" name="name" class="form-control" required>
    </div>
    <div class="mb-3">
      <label for="source" class="form-label">แหล่งสัญญาณ:</label>
      <input type="text" id="source" name="source" class="form-control" required>
    </div>
    <div class="mb-3">
      <label for="stream_type" class="form-label">ประเภทสตรีม:</label>
      <select id="stream_type" name="stream_type" class="form-select">
        <option value="opencv" selected>OpenCV</option>
        <option value="ffmpeg">FFmpeg</option>
      </select>
    </div>
    <div class="row mb-3">
      <div class="col-md-6 d-flex align-items-center">
        <div class="form-check me-2">
          <input class="form-check-input" type="checkbox" id="width-toggle">
          <label class="form-check-label" for="width-toggle">ความกว้าง:</label>
        </div>
        <input type="number" id="width" name="width" class="form-control" style="max-width:150px;" disabled>
      </div>
      <div class="col-md-6 d-flex align-items-center mt-2 mt-md-0">
        <div class="form-check me-2">
          <input class="form-check-input" type="checkbox" id="height-toggle">
          <label class="form-check-label" for="height-toggle">ความสูง:</label>
        </div>
        <input type="number" id="height" name="height" class="form-control" style="max-width:150px;" disabled>
      </div>
    </div>
    <button type="submit" class="btn btn-primary">สร้าง</button>
    </div>
  </form>

  <div class="card">
    <div class="card-header">
      <h3>รายการแหล่งสัญญาณ</h3>
    </div>
    <div class="card-body">
      <table class="table table-hover table-striped mt-3">
    <thead class="table-light">
      <tr>
        <th>ชื่อ</th>
        <th>แหล่งสัญญาณ</th>
        <th>สตรีม</th>
        <th>ความกว้าง</th>
        <th>ความสูง</th>
        <th>การจัดการ</th>
      </tr>
    </thead>
    <tbody id="source-table-body">
    </tbody>
  </table>
    </div>
  </div>

</div>

<script>
    const widthToggle = document.getElementById('width-toggle');
    const widthInput = document.getElementById('width');
    widthToggle.addEventListener('change', (e) => {
        widthInput.disabled = !e.target.checked;
        if (!e.target.checked) widthInput.value = '';
    });
    const heightToggle = document.getElementById('height-toggle');
    const heightInput = document.getElementById('height');
    heightToggle.addEventListener('change', (e) => {
        heightInput.disabled = !e.target.checked;
        if (!e.target.checked) heightInput.value = '';
    });

    async function loadSources() {
        try {
            const resp = await fetch('/source_list');
            if (!resp.ok) throw new Error('network');
            const data = await resp.json();
            const tbody = document.getElementById('source-table-body');
            tbody.innerHTML = '';
            data.forEach(src => {
                const tr = document.createElement('tr');
                const nameTd = document.createElement('td');
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.className = 'form-control form-control-sm';
                nameInput.value = src.name ?? '';
                nameInput.placeholder = 'ระบุชื่อแหล่งสัญญาณ';
                let originalName = nameInput.value;

                const saveName = async (newValue) => {
                    const trimmed = newValue.trim();
                    if (!trimmed) {
                        showAlert('ต้องระบุชื่อแหล่งสัญญาณ', 'error');
                        nameInput.value = originalName;
                        return;
                    }
                    if (trimmed === originalName.trim()) {
                        return;
                    }
                    nameInput.disabled = true;
                    try {
                        const res = await fetch(`/rename_source/${encodeURIComponent(originalName)}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name: trimmed })
                        });
                        const data = await res.json();
                        if (res.ok && (data.status === 'renamed' || data.status === 'unchanged')) {
                            originalName = trimmed;
                            showAlert('อัปเดตชื่อแหล่งสัญญาณแล้ว', 'success');
                            await loadSources();
                        } else {
                            nameInput.value = originalName;
                            showAlert(data.message || 'อัปเดตไม่สำเร็จ', 'error');
                        }
                    } catch (err) {
                        nameInput.value = originalName;
                        showAlert('อัปเดตไม่สำเร็จ', 'error');
                    } finally {
                        nameInput.disabled = false;
                    }
                };

                nameInput.addEventListener('blur', (e) => {
                    void saveName(e.target.value);
                });
                nameInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        nameInput.blur();
                    } else if (e.key === 'Escape') {
                        nameInput.value = originalName;
                        nameInput.blur();
                    }
                });
                nameTd.appendChild(nameInput);
                const sourceTd = document.createElement('td');
                const sourceInput = document.createElement('input');
                sourceInput.type = 'text';
                sourceInput.className = 'form-control form-control-sm';
                sourceInput.value = src.source ?? '';
                sourceInput.placeholder = 'ระบุแหล่งสัญญาณ';
                let originalSource = sourceInput.value;

                const saveSource = async (newValue) => {
                    const trimmed = newValue.trim();
                    if (trimmed === originalSource.trim()) {
                        return;
                    }
                    if (!trimmed) {
                        showAlert('ต้องระบุแหล่งสัญญาณ', 'error');
                        sourceInput.value = originalSource;
                        return;
                    }
                    sourceInput.disabled = true;
                    try {
                        const res = await fetch(`/update_source/${encodeURIComponent(src.name)}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ source: trimmed })
                        });
                        const data = await res.json();
                        if (res.ok && data.status === 'updated') {
                            originalSource = trimmed;
                            showAlert('อัปเดตแหล่งสัญญาณแล้ว', 'success');
                            await loadSources();
                        } else {
                            sourceInput.value = originalSource;
                            showAlert(data.message || 'อัปเดตไม่สำเร็จ', 'error');
                        }
                    } catch (err) {
                        sourceInput.value = originalSource;
                        showAlert('อัปเดตไม่สำเร็จ', 'error');
                    } finally {
                        sourceInput.disabled = false;
                    }
                };

                sourceInput.addEventListener('blur', (e) => {
                    void saveSource(e.target.value);
                });
                sourceInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        sourceInput.blur();
                    } else if (e.key === 'Escape') {
                        sourceInput.value = originalSource;
                        sourceInput.blur();
                    }
                });

                sourceTd.appendChild(sourceInput);
                const streamTd = document.createElement('td');
                const streamSelect = document.createElement('select');
                streamSelect.className = 'form-select form-select-sm';
                ['opencv', 'ffmpeg'].forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.textContent = opt;
                    if ((src.stream_type ?? 'opencv') === opt) option.selected = true;
                    streamSelect.appendChild(option);
                });
                streamSelect.addEventListener('change', async (e) => {
                    const newType = e.target.value;
                    try {
                        const res = await fetch(`/update_stream_type/${encodeURIComponent(src.name)}`, {
                            method: 'PATCH',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({stream_type: newType})
                        });
                        const data = await res.json();
                        if (res.ok && data.status === 'updated') {
                            showAlert('อัปเดตประเภทสตรีมแล้ว', 'success');
                            await loadSources();
                        } else {
                            showAlert(data.message || 'อัปเดตไม่สำเร็จ', 'error');
                        }
                    } catch (err) {
                        showAlert('อัปเดตไม่สำเร็จ', 'error');
                    }
                });
                streamTd.appendChild(streamSelect);
                const widthTd = document.createElement('td');
                const widthInput = document.createElement('input');
                widthInput.type = 'number';
                widthInput.className = 'form-control form-control-sm';
                widthInput.value = src.width ?? '';
                widthInput.placeholder = 'ไม่ระบุ';
                widthInput.min = '1';
                const heightTd = document.createElement('td');
                const heightInput = document.createElement('input');
                heightInput.type = 'number';
                heightInput.className = 'form-control form-control-sm';
                heightInput.value = src.height ?? '';
                heightInput.placeholder = 'ไม่ระบุ';
                heightInput.min = '1';

                let originalWidth = widthInput.value;
                let originalHeight = heightInput.value;

                const normaliseDimension = (value) => {
                    if (value === null || value === undefined) return '';
                    const str = String(value).trim();
                    return str;
                };

                const saveDimensions = async (newWidthRaw, newHeightRaw) => {
                    const newWidth = normaliseDimension(newWidthRaw);
                    const newHeight = normaliseDimension(newHeightRaw);

                    if (newWidth === normaliseDimension(originalWidth) && newHeight === normaliseDimension(originalHeight)) {
                        return;
                    }

                    const payload = {
                        width: newWidth === '' ? null : newWidth,
                        height: newHeight === '' ? null : newHeight,
                    };

                    widthInput.disabled = true;
                    heightInput.disabled = true;
                    try {
                        const res = await fetch(`/update_dimensions/${encodeURIComponent(src.name)}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const data = await res.json();
                        if (res.ok && (data.status === 'updated' || data.status === 'unchanged')) {
                            originalWidth = payload.width === null ? '' : payload.width;
                            originalHeight = payload.height === null ? '' : payload.height;
                            showAlert('อัปเดตขนาดวิดีโอแล้ว', 'success');
                            await loadSources();
                        } else {
                            widthInput.value = originalWidth;
                            heightInput.value = originalHeight;
                            showAlert(data.message || 'อัปเดตไม่สำเร็จ', 'error');
                        }
                    } catch (err) {
                        widthInput.value = originalWidth;
                        heightInput.value = originalHeight;
                        showAlert('อัปเดตไม่สำเร็จ', 'error');
                    } finally {
                        widthInput.disabled = false;
                        heightInput.disabled = false;
                    }
                };

                widthInput.addEventListener('blur', (e) => {
                    void saveDimensions(e.target.value, heightInput.value);
                });
                widthInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        widthInput.blur();
                    } else if (e.key === 'Escape') {
                        widthInput.value = originalWidth;
                        widthInput.blur();
                    }
                });

                heightInput.addEventListener('blur', (e) => {
                    void saveDimensions(widthInput.value, e.target.value);
                });
                heightInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        heightInput.blur();
                    } else if (e.key === 'Escape') {
                        heightInput.value = originalHeight;
                        heightInput.blur();
                    }
                });

                widthTd.appendChild(widthInput);
                heightTd.appendChild(heightInput);
                const actionTd = document.createElement('td');
                const delBtn = document.createElement('button');
                delBtn.textContent = 'ลบ';
                delBtn.className = 'btn btn-danger btn-sm';
                delBtn.addEventListener('click', async () => {
                    if (confirm(`ต้องการลบ ${src.name} หรือไม่?`)) {
                        try {
                            const delRes = await fetch(`/delete_source/${encodeURIComponent(src.name)}`, { method: 'DELETE' });
                            if (!delRes.ok) throw new Error('network');
                            showAlert('ลบแหล่งสัญญาณแล้ว', 'success');
                            await loadSources();
                        } catch (err) {
                            showAlert('ลบไม่สำเร็จ', 'error');
                        }
                    }
                });
                actionTd.appendChild(delBtn);
                tr.appendChild(nameTd);
                tr.appendChild(sourceTd);
                tr.appendChild(streamTd);
                tr.appendChild(widthTd);
                tr.appendChild(heightTd);
                tr.appendChild(actionTd);
                tbody.appendChild(tr);
            });
            showAlert('โหลดแหล่งสัญญาณแล้ว', 'success');
        } catch (err) {
            console.error('Failed to load sources', err);
            showAlert('โหลดแหล่งสัญญาณไม่สำเร็จ', 'error');
        }
    }

    document.getElementById('create-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        try {
            const res = await fetch('/create_source', { method: 'POST', body: formData });
            const data = await res.json();
            if (res.ok && data.status === 'created') {
                showAlert('สร้างแหล่งสัญญาณแล้ว', 'success');
                e.target.reset();
                widthInput.disabled = true;
                heightInput.disabled = true;
                await loadSources();
            } else {
                showAlert(data.message || 'สร้างไม่สำเร็จ', 'error');
            }
        } catch (err) {
            showAlert('สร้างไม่สำเร็จ', 'error');
        }
    });

    loadSources();

</script>
{% endblock %}
