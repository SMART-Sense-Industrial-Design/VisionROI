<h2>Inference Page</h2>
<p>Stream camera with ROI overlay.</p>
<div class="cam-row">
    <div class="card">
        <div id="cam1" class="cam-cell">
            <select id="cam1-sourceSelect" class="form-select mb-2"></select>
            <button id="cam1-startButton" class="btn btn-primary me-2">Start</button>
            <button id="cam1-stopButton" class="btn btn-danger" disabled>Stop</button>
            <p id="cam1-status"></p>
            <div class="video-wrapper">
                <img id="cam1-video" width="320" height="240" />
                <canvas id="cam1-overlay" class="overlay"></canvas>
            </div>
        </div>
    </div>
</div>
<script>
(function(){
function createController(cellId){
    let socket;
    let running=false;
    let rois=[];
    const cam=cellId.replace(/\D/g,'');
    const getEl=suffix=>document.getElementById(`${cellId}-${suffix}`);
    const video=getEl('video');
    video.onload=()=>{URL.revokeObjectURL(video.src);if(rois.length)drawOverlay();};
    const startButton=getEl('startButton');
    const stopButton=getEl('stopButton');
    const statusEl=getEl('status');
    const sourceSelect=getEl('sourceSelect');
    const overlay=getEl('overlay');
    const overlayCtx=overlay.getContext('2d');

    startButton.onclick=startStream;
    stopButton.onclick=stopStream;

    async function fetchWithStatus(url,options={}){
        statusEl.innerText='กำลังโหลด...';
        try{
            const res=await fetch(url,options);
            if(!res.ok)throw new Error('network');
            statusEl.innerText='สำเร็จ';
            return res;
        }catch(err){
            statusEl.innerText='เกิดข้อผิดพลาด';
            throw err;
        }
    }

    async function loadSources(){
        try{
            const res=await fetchWithStatus('/source_list');
            const data=await res.json();
            sourceSelect.innerHTML='';
            if(data.length===0){
                const opt=document.createElement('option');
                opt.value='';
                opt.textContent='No sources available';
                sourceSelect.appendChild(opt);
                statusEl.innerText='Create a source first';
                showAlert('No sources available','error');
            }else{
                data.forEach(item=>{
                    const opt=document.createElement('option');
                    opt.value=item.name;
                    opt.textContent=item.name;
                    sourceSelect.appendChild(opt);
                });
                showAlert('Sources loaded','success');
            }
        }catch(e){
            console.error('Failed to load sources',e);
            sourceSelect.innerHTML='';
            const opt=document.createElement('option');
            opt.value='';
            opt.textContent='Error loading sources';
            sourceSelect.appendChild(opt);
            statusEl.innerText='Error fetching sources';
            showAlert('Failed to load sources','error');
        }
    }

    async function startStream(){
        if(running)return;
        running=true;
        startButton.disabled=true;
        const name=sourceSelect.value;
        if(!name){
            statusEl.innerText='Select source first';
            running=false;
            startButton.disabled=false;
            showAlert('Select source first','error');
            return;
        }
        const cfgRes=await fetchWithStatus(`/source_config?name=${encodeURIComponent(name)}`);
        const cfg=await cfgRes.json();
        let roiPath=cfg.rois;
        if(!roiPath.startsWith('/'))roiPath=`data_sources/${cfg.name}/${roiPath}`;
        const startRes=await fetchWithStatus(`/start_inference/${cam}`,{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({...cfg,rois:[]})
        });
        const startData=await startRes.json();
        if(startData.status==='started'||startData.status==='already_running'){
            openSocket();
            await loadRoiFile(roiPath);
            setRunningUI();
            showAlert('Stream started','success');
        }else{
            running=false;
            startButton.disabled=false;
            showAlert('Failed to start stream','error');
        }
    }

    async function loadRoiFile(path){
        try{
            const roiRes=await fetchWithStatus(`/load_roi_file?path=${encodeURIComponent(path)}`);
            const data=await roiRes.json();
            rois=data.rois||[];
            drawOverlay();
        }catch(e){
            console.error('Failed to load ROI file',e);
            showAlert('Failed to load ROI file','error');
        }
    }

    function drawOverlay(){
        overlay.width=video.naturalWidth||video.width;
        overlay.height=video.naturalHeight||video.height;
        overlay.style.width=video.width+'px';
        overlay.style.height=video.height+'px';
        overlayCtx.clearRect(0,0,overlay.width,overlay.height);
        rois.forEach(r=>{
            if(!r.points)return;
            overlayCtx.beginPath();
            r.points.forEach((p,i)=>{
                if(i===0)overlayCtx.moveTo(p.x,p.y);
                else overlayCtx.lineTo(p.x,p.y);
            });
            overlayCtx.closePath();
            overlayCtx.lineWidth=2;
            overlayCtx.strokeStyle='lime';
            overlayCtx.stroke();
        });
    }

    function openSocket(){
        socket=new WebSocket(`ws://${location.host}/ws/${cam}`);
        socket.binaryType='arraybuffer';
        socket.onmessage=event=>{
            const blob=new Blob([event.data],{type:'image/jpeg'});
            video.src=URL.createObjectURL(blob);
        };
    }

    async function stopStream(){
        if(!running)return;
        running=false;
        await fetchWithStatus(`/stop_inference/${cam}`,{method:'POST'});
        if(socket){socket.close();socket=null;}
        overlayCtx.clearRect(0,0,overlay.width,overlay.height);
        video.src='';
        startButton.disabled=false;
        stopButton.disabled=true;
        statusEl.innerText='Stopped';
        showAlert('Stream stopped','info');
    }

    function setRunningUI(){
        startButton.disabled=true;
        stopButton.disabled=false;
        statusEl.innerText='Running';
    }

    loadSources();
}
document.addEventListener('DOMContentLoaded',()=>createController('cam1'));
})();
</script>

