
<div class="cam-row" data-row-label="สตรีม 1">
    <div class="video-col">
        <div class="card roi-card video-card">
            <div id="cam1" class="cam-cell">
            <div class="d-flex align-items-center mb-2 gap-2 menu-select-list">
                <label for="cam1-sourceSelect" class="form-label mb-0">Source:</label>
                <select id="cam1-sourceSelect" class="form-select w-auto"></select>
                <label for="cam1-intervalInput" class="form-label mb-0">Time:</label>
                <input id="cam1-intervalInput" type="number" class="form-control w-auto" min="0" step="0.1" value="1" />
            </div>
            <button id="cam1-startButton" class="btn btn-primary me-2">Start</button>
            <button id="cam1-stopButton" class="btn btn-danger" disabled>Stop</button>
            <p id="cam1-status"></p>
            <div class="video-wrapper">
                <canvas id="cam1-video" class="stream-video"></canvas>
                <p>page: <span id="cam1-pageName"></span></p>
                <table id="cam1-pageScores" class="table table-striped">
                    <thead><tr><th>Page</th><th>Score</th></tr></thead>
                    <tbody id="cam1-pageScoresBody"></tbody>
                </table>
            </div>
            </div>
        </div>
        <div class="card roi-card log-card">
            <div class="d-flex align-items-center mb-2 gap-2">
                <label for="cam1-logRoiSelect" class="form-label mb-0">ROI:</label>
                <select id="cam1-logRoiSelect" class="form-select w-auto"></select>
            </div>
            <div class="log-wrapper">
                <table id="cam1-logTable" class="table table-striped">
                    <thead><tr><th>Log</th></tr></thead>
                    <tbody id="cam1-logBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="card roi-card roi-list-card">
        <div id="cam1-rois" class="roi-grid"></div>
    </div>
</div>
<script>
(function(){
const DEFAULT_CELL_ID='cam1';

function resolveCellId(defaultId){
    const raw=String(window.location.hash||'').replace(/^#/,'').trim();
    if(!raw){
        return defaultId;
    }
    const match=/^cam(\d+)$/i.exec(raw);
    if(!match){
        return defaultId;
    }
    const num=parseInt(match[1],10);
    return Number.isFinite(num)&&num>0?`cam${num}`:defaultId;
}

function ensureLocationHash(cellId){
    const expected=`#${cellId}`;
    if(window.location.hash===expected){
        return;
    }
    const baseUrl=`${window.location.pathname}${window.location.search||''}`;
    window.history.replaceState(null,'',`${baseUrl}${expected}`);
}

function remapDomIds(baseId,targetId){
    if(!baseId||!targetId||baseId===targetId){
        return baseId;
    }
    const basePrefix=`${baseId}-`;
    const targetPrefix=`${targetId}-`;
    document.querySelectorAll(`[id^="${baseId}"]`).forEach(el=>{
        if(el.id===baseId){
            el.id=targetId;
        }else if(el.id.startsWith(basePrefix)){
            el.id=`${targetPrefix}${el.id.slice(basePrefix.length)}`;
        }
    });
    document.querySelectorAll(`[for^="${baseId}"]`).forEach(label=>{
        const current=label.getAttribute('for');
        if(!current){
            return;
        }
        if(current===baseId){
            label.setAttribute('for',targetId);
        }else if(current.startsWith(basePrefix)){
            label.setAttribute('for',`${targetPrefix}${current.slice(basePrefix.length)}`);
        }
    });
    return targetId;
}

function updateRowLabel(cellId){
    const row=document.querySelector('.cam-row');
    if(!row){
        return;
    }
    const match=/^cam(\d+)$/i.exec(cellId);
    if(match){
        row.dataset.rowLabel=`สตรีม ${match[1]}`;
    }
}

const requestedCellId=resolveCellId(DEFAULT_CELL_ID);
const cellId=remapDomIds(DEFAULT_CELL_ID,requestedCellId)||DEFAULT_CELL_ID;
updateRowLabel(cellId);
ensureLocationHash(cellId);

function initRoiLayout(cellId){
    const videoCell=document.getElementById(cellId);
    const videoCol=videoCell?videoCell.closest('.video-col'):null;
    const roiContainer=document.getElementById(`${cellId}-rois`);
    const roiCard=roiContainer?roiContainer.closest('.roi-list-card'):null;
    if(!videoCol||!roiCard){
        return;
    }
    const roiGrid=roiCard.querySelector('.roi-grid');
    if(roiGrid){
        roiGrid.style.height='100%';
    }
    const updateHeight=()=>{
        const rect=videoCol.getBoundingClientRect();
        if(rect&&rect.height){
            roiCard.style.maxHeight=`${rect.height}px`;
        }
    };
    updateHeight();
    if('ResizeObserver' in window){
        const observer=new ResizeObserver(()=>updateHeight());
        observer.observe(videoCol);
    }
    window.addEventListener('resize',updateHeight);
}
function createController(cellId){
    let socket;
    let roiSocket;
    let running=false;
    const cam=`page_${cellId}`;
    const sessionRegistry=window.InferenceSessions;
    const camRoot=document.getElementById(cellId);
    const camRow=camRoot?camRoot.closest('.cam-row'):null;
    const sessionTitle=camRow&&camRow.dataset.rowLabel?camRow.dataset.rowLabel:cellId;
    const getEl=suffix=>document.getElementById(`${cellId}-${suffix}`);
    const video=getEl('video');
    const videoCtx=video.getContext('2d');
    const pageNameEl=getEl('pageName');
    const scoreTableBody=getEl('pageScoresBody');
    const roiGrid=getEl('rois');
    const logBody=getEl('logBody');
    const logRoiSelect=getEl('logRoiSelect');
    let rois=[];
    let logTimer;
    let isLogUpdating=false;
    let logSessionId=0;

    function populateLogRoiSelect(){
        logRoiSelect.innerHTML='';
        const optAll=document.createElement('option');
        optAll.value='';
        optAll.textContent='All';
        logRoiSelect.appendChild(optAll);
        rois.forEach(r=>{
            const opt=document.createElement('option');
            opt.value=r.id;
            opt.textContent=r.id;
            logRoiSelect.appendChild(opt);
        });
    }

    populateLogRoiSelect();

    const startButton=getEl('startButton');
    const stopButton=getEl('stopButton');
    const statusEl=getEl('status');
    const sourceSelect=getEl('sourceSelect');
    const intervalInput=getEl('intervalInput');
    intervalInput.value=localStorage.getItem(`${cellId}-interval`)||'1';

    const formatTs=ts=>{
        if(!ts) return '';
        const d=new Date(ts*1000);
        const ms=String(d.getMilliseconds()).padStart(3,'0');
        return `${d.toLocaleTimeString('th-TH',{hour12:false})}.${ms}`;
    };

    const formatDuration=seconds=>{
        if(!Number.isFinite(seconds)||seconds<0)return '';
        if(seconds>=1){
            return `${seconds.toFixed(2)} s`;
        }
        if(seconds>=0.001){
            return `${Math.round(seconds*1000)} ms`;
        }
        return `${(seconds*1000).toFixed(2)} ms`;
    };

    startButton.onclick=startStream;
    stopButton.onclick=stopStream;
    sourceSelect.onchange=()=>{
        localStorage.setItem(`${cellId}-source`,sourceSelect.value);
    };
    logRoiSelect.onchange=()=>startLogUpdates(sourceSelect.value);

    async function fetchWithStatus(url,options={}){
        statusEl.innerText='กำลังโหลด...';
        try{
            const res=await fetch(url,options);
            if(!res.ok)throw new Error('network');
            statusEl.innerText='สำเร็จ';
            return res;
        }catch(err){
            statusEl.innerText='เกิดข้อผิดพลาด';
            throw err;
        }
    }

    async function loadSources(){
        try{
            const res=await fetchWithStatus('/source_list');
            const data=await res.json();
            sourceSelect.innerHTML='';
            if(data.length===0){
                const opt=document.createElement('option');
                opt.value='';
                opt.textContent='No sources available';
                sourceSelect.appendChild(opt);
                statusEl.innerText='Create a source first';
                showAlert('No sources available','error');
            }else{
                data.forEach(item=>{
                    const opt=document.createElement('option');
                    opt.value=item.name;
                    opt.textContent=item.name;
                    sourceSelect.appendChild(opt);
                });
                const stored=localStorage.getItem(`${cellId}-source`)||'';
                if(stored)sourceSelect.value=stored;
                showAlert('Sources loaded','success');
            }
        }catch(e){
            console.error('Failed to load sources',e);
            sourceSelect.innerHTML='';
            const opt=document.createElement('option');
            opt.value='';
            opt.textContent='Error loading sources';
            sourceSelect.appendChild(opt);
            statusEl.innerText='Error fetching sources';
            showAlert('Failed to load sources','error');
        }
    }

    async function startStream(){
        if(running)return;
        running=true;
        startButton.disabled=true;
        const name=sourceSelect.value;
        if(!name){
            statusEl.innerText='Select source first';
            running=false;
            startButton.disabled=false;
            showAlert('Select source first','error');
            return;
        }
        localStorage.setItem(`${cellId}-source`,name);
        const cfgRes=await fetchWithStatus(`/source_config?name=${encodeURIComponent(name)}`);
        const cfg=await cfgRes.json();
        const interval=parseFloat(intervalInput.value)||1;
        localStorage.setItem(`${cellId}-interval`,interval);
        let roiPath=cfg.rois;
        if(!roiPath.startsWith('/'))roiPath=`data_sources/${cfg.name}/${roiPath}`;
        let roiList=[];
        try{
            const roiRes=await fetchWithStatus(`/load_roi_file?path=${encodeURIComponent(roiPath)}`);
            const data=await roiRes.json();
            roiList=data.rois||[];
        }catch(e){
            console.error('Failed to load ROI file',e);
            showAlert('Failed to load ROI file','error');
        }

        rois=roiList.filter(r=>r.type==='roi');
        populateLogRoiSelect();
        roiGrid.innerHTML='';

        scoreTableBody.innerHTML='';

        let startData;
        let startRes;
        statusEl.innerText='กำลังโหลด...';
        try{
            startRes=await fetch(`/start_inference/${cam}`,{
                method:'POST',headers:{'Content-Type':'application/json'},
                body:JSON.stringify({...cfg,rois:roiList,interval})
            });
            startData=await startRes.json().catch(()=>({}));
        }catch(e){
            running=false;
            startButton.disabled=false;
            statusEl.innerText='เกิดข้อผิดพลาด';
            showAlert('Failed to start inference stream','error');
            return;
        }
        if(!startRes.ok || (startData.status!=='started' && startData.status!=='already_running')){
            running=false;
            startButton.disabled=false;
            statusEl.innerText='เกิดข้อผิดพลาด';
            if(startData.message==='open_failed'){
                showAlert('Failed to open video source','error');
            }else{
                showAlert('Failed to start inference stream','error');
            }
            return;
        }
        statusEl.innerText='สำเร็จ';
        openSocket();
        openRoiSocket();

        setRunningUI();
        startLogUpdates(cfg.name);
        showAlert('Stream started','success');
        const sourceOption=sourceSelect.options[sourceSelect.selectedIndex];
        if(sessionRegistry&&typeof sessionRegistry.upsertSession==='function'){
            sessionRegistry.upsertSession({
                id:cam,
                type:'page',
                title:sessionTitle,
                sourceId:sourceSelect.value||'',
                sourceName:sourceOption?sourceOption.textContent:'',
                page:pageNameEl?pageNameEl.textContent:'',
                href:`/inference/page#${cellId}`,
                status:'running'
            });
        }
        }


    function openSocket(){
        const wsScheme=location.protocol==='https:'?'wss':'ws';
        const wsBase=`${wsScheme}://${location.host}`;
        socket=new WebSocket(`${wsBase}/ws/${cam}`);
        socket.binaryType='blob';
        socket.onmessage=async event=>{
            const bitmap=await createImageBitmap(event.data);
            if(video.width!==bitmap.width||video.height!==bitmap.height){
                video.width=bitmap.width;
                video.height=bitmap.height;
            }
            videoCtx.drawImage(bitmap,0,0);
            bitmap.close();
        };
    }

    function openRoiSocket(){
        const wsScheme=location.protocol==='https:'?'wss':'ws';
        const wsBase=`${wsScheme}://${location.host}`;
        roiSocket=new WebSocket(`${wsBase}/ws_roi_result/${cam}`);
        roiSocket.onmessage=event=>{
            try{
                const data=JSON.parse(event.data);
                if('group' in data){
                    setTimeout(()=>{
                        pageNameEl.innerText=data.group||'';
                        if(sessionRegistry&&typeof sessionRegistry.updateSession==='function'){
                            sessionRegistry.updateSession(cam,{
                                page:data.group||'',
                                status:'running'
                            });
                        }
                        if(Array.isArray(data.scores)){
                            scoreTableBody.innerHTML='';
                            data.scores.forEach(item=>{
                                const tr=document.createElement('tr');
                                const tdPage=document.createElement('td');
                                tdPage.textContent=item.page||'';
                                const tdScore=document.createElement('td');
                                tdScore.textContent=item.score.toFixed(2);
                                tr.appendChild(tdPage);
                                tr.appendChild(tdScore);
                                scoreTableBody.appendChild(tr);
                            });
                        }
                    },0);
                }
                if(Array.isArray(data.results)){
                    const fallbackFrameTime=
                        typeof data.frame_time==='number'?data.frame_time:undefined;
                    setTimeout(()=>{
                        data.results.forEach(item=>applyRoiResult(item,fallbackFrameTime));
                    },0);
                }
                if(Object.prototype.hasOwnProperty.call(data,'id')){
                    setTimeout(()=>{
                        applyRoiResult(data);
                    },0);
                }
            }catch(e){}
        };
    }

    const getRoiContainerId=id=>`${cellId}-roi-item-${id}`;
    const getRoiTitleId=id=>`${cellId}-title-${id}`;
    const getRoiElementId=id=>`${cellId}-roi-${id}`;
    const getRoiTextId=id=>`${cellId}-text-${id}`;
    const getRoiTimeId=id=>`${cellId}-time-${id}`;
    const getRoiModuleId=id=>`${cellId}-module-${id}`;

    function findRoiDataById(id){
        const key=String(id);
        return rois.find(r=>String(r?.id)===key)||null;
    }

    function normalizeModule(value){
        return typeof value==='string'?value.trim():'';
    }

    function updateRoiModuleLabel(id,override=''){
        const moduleEl=document.getElementById(getRoiModuleId(id));
        if(!moduleEl)return;
        const overrideText=normalizeModule(override);
        const fallback=normalizeModule(findRoiDataById(id)?.module??'');
        const moduleName=overrideText||fallback;
        moduleEl.textContent=moduleName?`โมดูล: ${moduleName}`:'โมดูล: -';
    }

    function updateRoiTitle(id,nameOverride=''){
        const titleEl=document.getElementById(getRoiTitleId(id));
        if(!titleEl)return;
        const fallback=findRoiDataById(id)?.name;
        const title=nameOverride||fallback||`ROI ${id}`;
        titleEl.textContent=title;
    }

    function ensureRoiItem(id,nameOverride=''){
        const key=String(id);
        const existing=document.getElementById(getRoiContainerId(key));
        if(existing){
            updateRoiTitle(key,nameOverride);
            return existing;
        }
        const r=findRoiDataById(key)||{id:key};
        const item=document.createElement('div');
        item.className='roi-item';
        item.id=getRoiContainerId(key);
        const title=document.createElement('h4');
        title.className='roi-title';
        title.id=getRoiTitleId(key);
        title.textContent=nameOverride||r.name||`ROI ${key}`;
        const img=document.createElement('img');
        img.id=getRoiElementId(key);
        img.className='roi-image';
        img.alt=`ROI ${key}`;
        img.loading='lazy';
        const moduleLine=document.createElement('p');
        moduleLine.id=getRoiModuleId(key);
        moduleLine.className='roi-module';
        const t=document.createElement('p');
        t.id=getRoiTimeId(key);
        t.className='roi-time';
        const p=document.createElement('p');
        p.id=getRoiTextId(key);
        p.className='roi-text';
        item.appendChild(title);
        item.appendChild(img);
        item.appendChild(moduleLine);
        item.appendChild(t);
        item.appendChild(p);
        roiGrid.appendChild(item);
        updateRoiModuleLabel(key);
        return item;
    }

    function removeRoiItem(id){
        const item=document.getElementById(getRoiContainerId(id));
        if(item && item.parentNode){
            item.parentNode.removeChild(item);
        }
    }

    function applyRoiResult(result,fallbackFrameTime){
        if(!result)return;
        const roiId=result.id;
        if(roiId===undefined||roiId===null)return;
        const key=String(roiId);
        const imageData=typeof result.image==='string'?result.image.trim():'';
        const candidates=[result.text,result.result,result.value,result.ocr];
        const text=candidates.find(v=>typeof v==='string'&&v.trim().length>0)?.trim()||'';
        const duration=typeof result.duration==='number'?result.duration:Number.NaN;
        const durationText=formatDuration(duration);
        const ts=typeof result.frame_time==='number'?result.frame_time:fallbackFrameTime;
        const hasTimestamp=Number.isFinite(ts);
        const shouldDisplay=Boolean((imageData&&imageData.length>0)||text||durationText);
        if(!shouldDisplay){
            removeRoiItem(key);
            return;
        }
        const displayName=typeof result.name==='string'?result.name.trim():'';
        ensureRoiItem(key,displayName);
        updateRoiModuleLabel(key,result.module);
        updateRoiTitle(key,displayName);
        const imgEl=document.getElementById(getRoiElementId(key));
        if(imgEl && Object.prototype.hasOwnProperty.call(result,'image')){
            if(imageData){
                const src=imageData.startsWith('data:')?imageData:`data:image/jpeg;base64,${imageData}`;
                imgEl.src=src;
                imgEl.classList.remove('d-none');
            }else{
                imgEl.src='';
                imgEl.classList.add('d-none');
            }
        }
        const textEl=document.getElementById(getRoiTextId(key));
        if(textEl){
            textEl.textContent=text?`ข้อความ: ${text}`:'ข้อความ: -';
        }
        const timeEl=document.getElementById(getRoiTimeId(key));
        if(timeEl){
            if(durationText){
                timeEl.textContent=`เวลา: ${durationText}`;
            }else if(hasTimestamp){
                timeEl.textContent=`เวลา: ${formatTs(ts)}`;
            }else{
                timeEl.textContent='';
            }
        }
    }

    function startLogUpdates(sourceName){
        stopLogUpdates();
        const sessionId=logSessionId;
        isLogUpdating=true;
        async function fetchLog(){
            if(!isLogUpdating||sessionId!==logSessionId){
                return;
            }
            try{
                const res=await fetch(`/read_log?source=${encodeURIComponent(sourceName)}&lines=40&_=${Date.now()}`);
                const data=await res.json();
                if(sessionId!==logSessionId){
                    return;
                }
                logBody.innerHTML='';
                const filter=logRoiSelect.value;
                const lines=(data.lines||[]).slice().reverse();
                lines.forEach(line=>{
                    const marker='AGGREGATED_ROI ';
                    const idx=line.indexOf(marker);
                    if(idx!==-1){
                        const prefix=line.slice(0,idx).trim();
                        const payload=line.slice(idx+marker.length).trim();
                        try{
                            const parsed=JSON.parse(payload);
                            const results=Array.isArray(parsed.results)?parsed.results:[];
                            const frameTs=typeof parsed.frame_time==='number'?parsed.frame_time:null;
                            const resultTs=typeof parsed.result_time==='number'?parsed.result_time:null;
                            const groupLabel=parsed.group||'';
                            results.forEach(res=>{
                                const roiId=res?.id??res?.roi_id??res?.ROI_ID;
                                if(roiId===undefined||roiId===null)return;
                                if(filter && String(roiId)!==filter)return;
                                const tr=document.createElement('tr');
                                const td=document.createElement('td');
                                const parts=[];
                                if(prefix)parts.push(prefix);
                                if(frameTs)parts.push(`frame=${formatTs(frameTs)}`);
                                if(resultTs)parts.push(`result=${formatTs(resultTs)}`);
                                parts.push(`roi_id=${roiId}`);
                                if(res.name)parts.push(`name=${res.name}`);
                                const moduleName=typeof res.module==='string'?res.module.trim():'';
                                if(moduleName)parts.push(`module=${moduleName}`);
                                if(groupLabel)parts.push(`group=${groupLabel}`);
                                if(typeof res.duration==='number'){
                                    const dur=formatDuration(res.duration);
                                    if(dur)parts.push(`duration=${dur}`);
                                }
                                const textValue=typeof res.text==='string'?res.text:'';
                                parts.push(`text=${textValue}`);
                                td.textContent=parts.join(' | ');
                                tr.appendChild(td);
                                logBody.appendChild(tr);
                            });
                            return;
                        }catch(e){}
                    }
                    if(filter && !line.includes(`roi_id=${filter}`))return;
                    const tr=document.createElement('tr');
                    const td=document.createElement('td');
                    td.textContent=line;
                    tr.appendChild(td);
                    logBody.appendChild(tr);
                });
            }catch(e){}
            finally{
                if(isLogUpdating&&sessionId===logSessionId){
                    logTimer=setTimeout(fetchLog,1000);
                }
            }
        }
        fetchLog();
    }

    function stopLogUpdates(){
        isLogUpdating=false;
        logSessionId++;
        if(logTimer){
            clearTimeout(logTimer);
            logTimer=null;
        }
        logBody.innerHTML='';
    }

    async function stopStream(){
        if(!running)return;
        running=false;
        await fetchWithStatus(`/stop_inference/${cam}`,{method:'POST'});
        if(socket){socket.close();socket=null;}
        if(roiSocket){roiSocket.close();roiSocket=null;}
        stopLogUpdates();
        videoCtx.clearRect(0,0,video.width,video.height);
        rois=[];
        populateLogRoiSelect();
        roiGrid.innerHTML='';
        pageNameEl.innerText='';
        scoreTableBody.innerHTML='';
        startButton.disabled=false;
        stopButton.disabled=true;
        statusEl.innerText='Stopped';
        showAlert('Stream stopped','info');
        if(sessionRegistry&&typeof sessionRegistry.updateSession==='function'){
            sessionRegistry.updateSession(cam,{
                status:'stopped',
                page:''
            });
        }
    }

    function setRunningUI(){
        startButton.disabled=true;
        stopButton.disabled=false;
        statusEl.innerText='Running';
    }

    async function checkStatus(){
        try{
            const res=await fetchWithStatus(`/inference_status/${cam}`);
            const data=await res.json();
            try{
                const srcRes=await fetch(`/roi_stream_status/${cam}`);
                if(srcRes.ok){
                    const srcData=await srcRes.json();
                    if(srcData.source){
                        sourceSelect.value=srcData.source;
                        localStorage.setItem(`${cellId}-source`,srcData.source);
                    }
                }
            }catch(e){}
            if(data.running){
                const name=sourceSelect.value;
                openSocket();
                openRoiSocket();
                scoreTableBody.innerHTML='';
                if(name){
                    const cfgRes=await fetchWithStatus(`/source_config?name=${encodeURIComponent(name)}`);
                    const cfg=await cfgRes.json();
                    let roiPath=cfg.rois;
                    if(!roiPath.startsWith('/'))roiPath=`data_sources/${cfg.name}/${roiPath}`;
                    const roiRes=await fetchWithStatus(`/load_roi_file?path=${encodeURIComponent(roiPath)}`);
                    const roiData=await roiRes.json();
                    rois=(roiData.rois||[]).filter(r=>r.type==='roi');
                    populateLogRoiSelect();
                    roiGrid.innerHTML='';
                    startLogUpdates(cfg.name);
                }
                setRunningUI();
                running=true;
                showAlert('Stream resumed','info');
            }else{
                statusEl.innerText='Idle';
            }
        }catch(e){
            statusEl.innerText='Error checking status';
        }
    }

    (async()=>{
        await loadSources();
        await checkStatus();
    })();
}
initRoiLayout(cellId);
createController(cellId);
})();
</script>

