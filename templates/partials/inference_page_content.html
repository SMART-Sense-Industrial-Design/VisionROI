<h2>Inference Page</h2>
<p>Stream camera with ROI overlay.</p>
<div class="cam-row">
    <div class="card roi-card">
        <div id="cam1" class="cam-cell">
            <div class="d-flex align-items-center mb-2 gap-2 menu-select-list">
                <label for="cam1-sourceSelect" class="form-label mb-0">Source:</label>
                <select id="cam1-sourceSelect" class="form-select w-auto"></select>
            </div>
            <button id="cam1-startButton" class="btn btn-primary me-2">Start</button>
            <button id="cam1-stopButton" class="btn btn-danger" disabled>Stop</button>
            <p id="cam1-status"></p>
            <div class="video-wrapper">
                <img id="cam1-video" width="320" height="240" />
                <p>page: <span id="cam1-pageName"></span></p>
                <table id="cam1-pageScores" class="table">
                    <thead><tr><th>Page</th><th>Score</th></tr></thead>
                    <tbody id="cam1-pageScoresBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="card roi-card">
        <div id="cam1-rois" class="roi-grid"></div>
    </div>
</div>
<script>
(function(){
function createController(cellId){
    let socket;
    let roiSocket;
    let running=false;
    const cam=`page_${cellId}`;
    const getEl=suffix=>document.getElementById(`${cellId}-${suffix}`);
    const video=getEl('video');
    const pageNameEl=getEl('pageName');
    const scoreTableBody=getEl('pageScoresBody');
    const roiGrid=getEl('rois');
    let rois=[];

    const startButton=getEl('startButton');
    const stopButton=getEl('stopButton');
    const statusEl=getEl('status');
    const sourceSelect=getEl('sourceSelect');


    startButton.onclick=startStream;
    stopButton.onclick=stopStream;
    sourceSelect.onchange=()=>{
        localStorage.setItem(`${cellId}-source`,sourceSelect.value);
    };

    async function fetchWithStatus(url,options={}){
        statusEl.innerText='กำลังโหลด...';
        try{
            const res=await fetch(url,options);
            if(!res.ok)throw new Error('network');
            statusEl.innerText='สำเร็จ';
            return res;
        }catch(err){
            statusEl.innerText='เกิดข้อผิดพลาด';
            throw err;
        }
    }

    async function loadSources(){
        try{
            const res=await fetchWithStatus('/source_list');
            const data=await res.json();
            sourceSelect.innerHTML='';
            if(data.length===0){
                const opt=document.createElement('option');
                opt.value='';
                opt.textContent='No sources available';
                sourceSelect.appendChild(opt);
                statusEl.innerText='Create a source first';
                showAlert('No sources available','error');
            }else{
                data.forEach(item=>{
                    const opt=document.createElement('option');
                    opt.value=item.name;
                    opt.textContent=item.name;
                    sourceSelect.appendChild(opt);
                });
                const stored=localStorage.getItem(`${cellId}-source`)||'';
                if(stored)sourceSelect.value=stored;
                showAlert('Sources loaded','success');
            }
        }catch(e){
            console.error('Failed to load sources',e);
            sourceSelect.innerHTML='';
            const opt=document.createElement('option');
            opt.value='';
            opt.textContent='Error loading sources';
            sourceSelect.appendChild(opt);
            statusEl.innerText='Error fetching sources';
            showAlert('Failed to load sources','error');
        }
    }

    async function startStream(){
        if(running)return;
        running=true;
        startButton.disabled=true;
        const name=sourceSelect.value;
        if(!name){
            statusEl.innerText='Select source first';
            running=false;
            startButton.disabled=false;
            showAlert('Select source first','error');
            return;
        }
        localStorage.setItem(`${cellId}-source`,name);
        const cfgRes=await fetchWithStatus(`/source_config?name=${encodeURIComponent(name)}`);
        const cfg=await cfgRes.json();
        let roiPath=cfg.rois;
        if(!roiPath.startsWith('/'))roiPath=`data_sources/${cfg.name}/${roiPath}`;
        let roiList=[];
        try{
            const roiRes=await fetchWithStatus(`/load_roi_file?path=${encodeURIComponent(roiPath)}`);
            const data=await roiRes.json();
            roiList=data.rois||[];
        }catch(e){
            console.error('Failed to load ROI file',e);
            showAlert('Failed to load ROI file','error');
        }

        rois=roiList.filter(r=>r.type==='roi');
        if(rois.length>0){
            renderRoiPlaceholders();
        }else{
            roiGrid.innerHTML='';
        }

        scoreTableBody.innerHTML='';

        const startRes=await fetchWithStatus(`/start_inference/${cam}`,{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({...cfg,rois:roiList})
        });
        const startData=await startRes.json();
        if(startData.status==='started'||startData.status==='already_running'){
            openSocket();
            openRoiSocket();

            setRunningUI();
            showAlert('Stream started','success');
        }else{
            running=false;
            startButton.disabled=false;
            showAlert('Failed to start stream','error');
        }
    }


    function openSocket(){
        socket=new WebSocket(`ws://${location.host}/ws/${cam}`);
        socket.binaryType='arraybuffer';
        socket.onmessage=event=>{
            const blob=new Blob([event.data],{type:'image/jpeg'});
            video.src=URL.createObjectURL(blob);
        };
    }

    function openRoiSocket(){
        roiSocket=new WebSocket(`ws://${location.host}/ws_roi_result/${cam}`);
        roiSocket.onmessage=event=>{
            try{
                const data=JSON.parse(event.data);
                if('group' in data){
                    pageNameEl.innerText=data.group||'';
                    if(Array.isArray(data.scores)){
                        scoreTableBody.innerHTML='';
                        data.scores.forEach(item=>{
                            const tr=document.createElement('tr');
                            const tdPage=document.createElement('td');
                            tdPage.textContent=item.page||'';
                            const tdScore=document.createElement('td');
                            tdScore.textContent=item.score.toFixed(2);
                            tr.appendChild(tdPage);
                            tr.appendChild(tdScore);
                            scoreTableBody.appendChild(tr);
                        });
                    }
                }else if(data.id){
                    const imgEl=document.getElementById(`${cellId}-roi-${data.id}`);
                    if(imgEl){imgEl.src=`data:image/jpeg;base64,${data.image}`;}
                    const textEl=document.getElementById(`${cellId}-text-${data.id}`);
                    if(textEl){textEl.textContent=data.text||'';}

                }
            }catch(e){}
        };
    }

    function renderRoiPlaceholders(list=rois){
        roiGrid.innerHTML='';
        list.forEach(r=>{
            const item=document.createElement('div');
            item.className='roi-item';
            const title=document.createElement('h4');
            title.className='roi-title';
            title.textContent=r.name||`ROI ${r.id}`;
            const img=document.createElement('img');
            img.id=`${cellId}-roi-${r.id}`;
            img.className='roi-image';
            const p=document.createElement('p');
            p.id=`${cellId}-text-${r.id}`;
            p.className='roi-text';
            item.appendChild(title);
            item.appendChild(img);
            item.appendChild(p);
            roiGrid.appendChild(item);
        });
    }

    async function stopStream(){
        if(!running)return;
        running=false;
        await fetchWithStatus(`/stop_inference/${cam}`,{method:'POST'});
        if(socket){socket.close();socket=null;}
        if(roiSocket){roiSocket.close();roiSocket=null;}
        video.src='';
        pageNameEl.innerText='';
        scoreTableBody.innerHTML='';
        startButton.disabled=false;
        stopButton.disabled=true;
        statusEl.innerText='Stopped';
        showAlert('Stream stopped','info');
    }

    function setRunningUI(){
        startButton.disabled=true;
        stopButton.disabled=false;
        statusEl.innerText='Running';
    }

    async function checkStatus(){
        try{
            const res=await fetchWithStatus(`/inference_status/${cam}`);
            const data=await res.json();
            try{
                const srcRes=await fetch(`/roi_stream_status/${cam}`);
                if(srcRes.ok){
                    const srcData=await srcRes.json();
                    if(srcData.source){
                        sourceSelect.value=srcData.source;
                        localStorage.setItem(`${cellId}-source`,srcData.source);
                    }
                }
            }catch(e){}
            if(data.running){
                const name=sourceSelect.value;
                openSocket();
                openRoiSocket();
                scoreTableBody.innerHTML='';
                if(name){
                    const cfgRes=await fetchWithStatus(`/source_config?name=${encodeURIComponent(name)}`);
                    const cfg=await cfgRes.json();
                    let roiPath=cfg.rois;
                    if(!roiPath.startsWith('/'))roiPath=`data_sources/${cfg.name}/${roiPath}`;
                    const roiRes=await fetchWithStatus(`/load_roi_file?path=${encodeURIComponent(roiPath)}`);
                    const roiData=await roiRes.json();
                    rois=(roiData.rois||[]).filter(r=>r.type==='roi');
                    if(rois.length>0)renderRoiPlaceholders();
                }
                setRunningUI();
                running=true;
                showAlert('Stream resumed','info');
            }else{
                statusEl.innerText='Idle';
            }
        }catch(e){
            statusEl.innerText='Error checking status';
        }
    }

    (async()=>{
        await loadSources();
        await checkStatus();
    })();
}
document.addEventListener('DOMContentLoaded',()=>createController('cam1'));
})();
</script>

