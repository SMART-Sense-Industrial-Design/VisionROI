<!DOCTYPE html>
<html>
<head>
    <title>Quart ROI Selector</title>
    <style>
        #video { border: 1px solid black; position: relative; }
        #canvas { position: absolute; left: 0; top: 0; }
    </style>
</head>
<body>
    <select id="sourceSelect"></select>
    <button onclick="startStream()">Start</button>
    <button onclick="stopStream()">Stop</button>
    <button onclick="saveAllRois()">Save All</button>
    <br><br>
    <div style="position: relative; display: inline-block;">
        <img id="video" />
        <canvas id="canvas"></canvas>
    </div>

    <script>
        let socket;
        let drawing = false;
        let startX, startY;
        let rois = [];
        let roiPath = "";

        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");

        video.onload = () => {
            canvas.width = video.naturalWidth;
            canvas.height = video.naturalHeight;
            canvas.style.width = video.naturalWidth + 'px';
            canvas.style.height = video.naturalHeight + 'px';
        };

        async function loadSources() {
            const res = await fetch("/sources");
            const data = await res.json();
            const select = document.getElementById("sourceSelect");
            data.forEach(name => {
                const opt = document.createElement("option");
                opt.value = name;
                opt.textContent = name;
                select.appendChild(opt);
            });
        }

        loadSources();

        async function startStream() {
            const name = document.getElementById("sourceSelect").value;
            if (!name) {
                alert("Select source first");
                return;
            }
            const cfg = await fetch(`/source_config?name=${encodeURIComponent(name)}`).then(r => r.json());
            roiPath = cfg.rois;
            await fetch("/set_camera", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ source: cfg.source })
            });
            await fetch("/start_roi_stream", { method: "POST" });
            socket = new WebSocket("ws://" + location.host + "/ws_roi");
            socket.onmessage = function(event) {
                video.src = 'data:image/jpeg;base64,' + event.data;
            };
            await loadRois();
        }

        async function stopStream() {

            if (socket) {
                socket.close();
                socket = null;
            }

            await fetch("/stop_roi_stream", { method: "POST" });

        }

        canvas.onmousedown = (e) => {
            drawing = true;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            startX = (e.clientX - rect.left) * scaleX;
            startY = (e.clientY - rect.top) * scaleY;
        };

        canvas.onmouseup = (e) => {
            if (!drawing) return;
            drawing = false;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const endX = (e.clientX - rect.left) * scaleX;
            const endY = (e.clientY - rect.top) * scaleY;
            const roi = {
                x: Math.min(startX, endX),
                y: Math.min(startY, endY),
                width: Math.abs(endX - startX),
                height: Math.abs(endY - startY)
            };
            rois.push(roi);
            drawAllRois();
        };

        canvas.onmousemove = (e) => {
            if (!drawing) return;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const currX = (e.clientX - rect.left) * scaleX;
            const currY = (e.clientY - rect.top) * scaleY;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawAllRois();
            ctx.beginPath();
            ctx.rect(startX, startY, currX - startX, currY - startY);
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.stroke();
        };

        function drawAllRois() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            rois.forEach(r => {
                ctx.beginPath();
                ctx.rect(r.x, r.y, r.width, r.height);
                ctx.strokeStyle = 'blue';
                ctx.lineWidth = 2;
                ctx.stroke();
            });
        }

        async function loadRois() {
            if (!roiPath) {
                rois = [];
                drawAllRois();
                return;
            }
            const res = await fetch(`/load_roi_file?path=${encodeURIComponent(roiPath)}`);
            const data = await res.json();
            rois = data.rois;
            drawAllRois();
        }

        function saveAllRois() {
            if (rois.length === 0) {
                alert("No ROI selected.");
                return;
            }
            if (!confirm("Save all ROIs?")) return;

            fetch(`/save_roi?path=${encodeURIComponent(roiPath)}` , {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ rois: rois })
            })
            .then(res => res.json())
            .then(data => {
                alert("Saved to: " + data.filename);
                loadRois();
            });
        }
    
    </script>
</body>
</html>
