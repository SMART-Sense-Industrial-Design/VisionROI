{% extends "base.html" %}
{% block title %}ROI Selection{% endblock %}
{% block content %}

<style>
    #video { border: 1px solid black; position: relative; }
    #canvas {
        position: absolute;
        left: 0;
        top: 0;
        z-index: 1;
        pointer-events: none;
    }
</style>

<select id="sourceSelect"></select>
<button id="startBtn">Start</button>
<button id="stopBtn" disabled>Stop</button>
<button id="saveBtn">Save All</button>
<button id="clearBtn">Clear All</button>
<br><br>
<div id="frameContainer" style="position: relative; display: inline-block;">
    <img id="video" />
    <canvas id="canvas"></canvas>
</div>

<div id="roiList"></div>

<script>
    (function() {
        let socket;
        let rois = [];
        let currentPoints = [];
        let hoverPoint = null;
        let currentSource = "";
        let modules = [];
        let initialized = false;
        let isStreaming = false;
        let hasStarted = false;
        const cam = 1;

        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const frameContainer = document.getElementById("frameContainer");
        const ctx = canvas.getContext("2d");
        const startBtn = document.getElementById("startBtn");
        const stopBtn = document.getElementById("stopBtn");

        video.onload = () => {
            if (!initialized || canvas.width !== video.naturalWidth || canvas.height !== video.naturalHeight) {
                canvas.width = video.naturalWidth;
                canvas.height = video.naturalHeight;
                canvas.style.width = video.naturalWidth + 'px';
                canvas.style.height = video.naturalHeight + 'px';
                frameContainer.style.width = video.naturalWidth + 'px';
                frameContainer.style.height = video.naturalHeight + 'px';
                initialized = true;
            }
            drawAllRois();
            URL.revokeObjectURL(video.src);
        };

        async function loadSources() {
            const res = await fetch("/source_list");
            const data = await res.json();
            const select = document.getElementById("sourceSelect");
            select.innerHTML = '';

            data.forEach(item => {
                const opt = document.createElement("option");
                opt.value = item.name;
                opt.textContent = item.name;
                select.appendChild(opt);
            });
        }

        async function loadModules() {
            try {
                const res = await fetch('/inference_modules');
                if (!res.ok) throw new Error('Bad response');
                modules = await res.json();
                renderRoiList();
            } catch (err) {
                console.error('Failed to load modules', err);
                modules = [];
                renderRoiList();
            }
        }

        function openSocket() {
            socket = new WebSocket(`ws://${location.host}/ws_roi/${cam}`);
            socket.binaryType = "arraybuffer";
            socket.onmessage = function(event) {
                const blob = new Blob([event.data], { type: "image/jpeg" });
                video.src = URL.createObjectURL(blob);
            };
            socket.onclose = function() {
                socket = null;
                isStreaming = false;
                stopBtn.disabled = true;
                console.log("ROI stream closed");
            };
        }

        async function checkStatus() {
            const res = await fetch(`/roi_stream_status/${cam}`);
            const data = await res.json();
            if (data.running) {
                const select = document.getElementById("sourceSelect");
                if (data.source) {
                    select.value = data.source;
                    currentSource = data.source;
                    await loadRois();
                }
                openSocket();
                isStreaming = true;
                startBtn.disabled = true;
                startBtn.textContent = "Start";
                stopBtn.disabled = false;
            } else {
                startBtn.disabled = false;
                startBtn.textContent = "Start";
                stopBtn.disabled = true;
            }
        }

        async function startStream() {
            if (hasStarted) return;
            if (isStreaming) return;
            hasStarted = true;
            const name = document.getElementById("sourceSelect").value;
            if (!name) {
                alert("Select source first");
                return;
            }
            startBtn.disabled = true;
            currentSource = name;
            const cfg = await fetch(`/source_config?name=${encodeURIComponent(name)}`).then(r => r.json());
            const setRes = await fetch(`/set_camera/${cam}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name, source: cfg.source })
            });
            if (!setRes.ok) {
                alert("Failed to set camera");
                isStreaming = false;
                startBtn.disabled = false;
                stopBtn.disabled = true;
                return;
            }
            const startRes = await fetch(`/start_roi_stream/${cam}`, { method: "POST" });
            if (!startRes.ok) {
                alert("Failed to start ROI stream");
                isStreaming = false;
                startBtn.disabled = false;
                stopBtn.disabled = true;
                return;
            }
            openSocket();
            await loadRois();
            isStreaming = true;
            stopBtn.disabled = false;
            startBtn.textContent = "Start";
        }

        async function stopStream() {
            if (socket) {
                socket.close();
                socket = null;
            }
            try {
                await fetch(`/stop_roi_stream/${cam}`, { method: 'POST', keepalive: true });
            } catch (err) {
                console.error('Failed to stop ROI stream', err);
            }
            video.src = "";
            isStreaming = false;
            stopBtn.disabled = true;
        }

        frameContainer.addEventListener('click', (e) => {
            const rect = frameContainer.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            currentPoints.push({ x, y });
            if (currentPoints.length === 4) {
                const roiId = prompt("ROI id?");
                if (roiId !== null) {
                    let selectedModule = null;
                    if (modules.length > 0) {
                        selectedModule = prompt("Module? (" + modules.join(", ") + ")");
                    }
                    rois.push({ id: roiId, module: selectedModule, points: [...currentPoints] });
                }
                currentPoints = [];
                hoverPoint = null;
                renderRoiList();
            }
            drawAllRois();
        });

        frameContainer.addEventListener('mousemove', (e) => {
            const rect = frameContainer.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            hoverPoint = { x, y };
            drawAllRois();
        });

        frameContainer.addEventListener('mouseleave', () => {
            hoverPoint = null;
            drawAllRois();
        });

        function drawAllRois() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            rois.forEach(r => {
                if (!r.points || r.points.length === 0) return;
                ctx.beginPath();
                ctx.moveTo(r.points[0].x, r.points[0].y);
                for (let i = 1; i < r.points.length; i++) {
                    ctx.lineTo(r.points[i].x, r.points[i].y);
                }
                ctx.closePath();
                ctx.strokeStyle = 'blue';
                ctx.lineWidth = 2;
                ctx.stroke();
                r.points.forEach(p => {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 5, 0, 2 * Math.PI);
                    ctx.fillStyle = 'blue';
                    ctx.fill();
                });
                if (r.id !== undefined) {
                    ctx.font = '16px sans-serif';
                    ctx.fillStyle = 'blue';
                    ctx.fillText(r.id, r.points[0].x, Math.max(10, r.points[0].y - 5));
                }
            });
            if (currentPoints.length > 0) {
                ctx.beginPath();
                ctx.moveTo(currentPoints[0].x, currentPoints[0].y);
                for (let i = 1; i < currentPoints.length; i++) {
                    ctx.lineTo(currentPoints[i].x, currentPoints[i].y);
                }
                ctx.strokeStyle = 'red';
                ctx.lineWidth = 2;
                ctx.stroke();
                currentPoints.forEach(p => {
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 5, 0, 2 * Math.PI);
                    ctx.fillStyle = 'red';
                    ctx.fill();
                });
                if (hoverPoint) {
                    const last = currentPoints[currentPoints.length - 1];
                    ctx.beginPath();
                    ctx.moveTo(last.x, last.y);
                    ctx.lineTo(hoverPoint.x, hoverPoint.y);
                    ctx.strokeStyle = 'red';
                    ctx.lineWidth = 1;
                    ctx.setLineDash([5, 5]);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
            }
        }

        function renderRoiList() {
            const container = document.getElementById('roiList');
            if (!container) return;
            container.innerHTML = '';

            if (rois.length === 0) return;

            const table = document.createElement('table');
            table.classList.add('roi-table');
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            ['ID', 'x', 'y', 'w', 'h', 'Module'].forEach(col => {
                const th = document.createElement('th');
                th.textContent = col;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            rois.forEach((r, idx) => {
                const xs = r.points.map(p => p.x);
                const ys = r.points.map(p => p.y);
                const x = Math.min(...xs);
                const y = Math.min(...ys);
                const w = Math.max(...xs) - x;
                const h = Math.max(...ys) - y;
                const tr = document.createElement('tr');
                const idTd = document.createElement('td');
                idTd.textContent = r.id;
                tr.appendChild(idTd);
                [x, y, w, h].forEach(val => {
                    const td = document.createElement('td');
                    td.textContent = Math.round(val);
                    tr.appendChild(td);
                });
                const tdModule = document.createElement('td');
                const select = document.createElement('select');
                const empty = document.createElement('option');
                empty.value = '';
                empty.textContent = '';
                select.appendChild(empty);
                modules.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m;
                    opt.textContent = m;
                    select.appendChild(opt);
                });
                select.value = r.module || '';
                select.addEventListener('change', e => updateRoiModule(idx, e.target.value));
                tdModule.appendChild(select);
                tr.appendChild(tdModule);
                tbody.appendChild(tr);
            });

            table.appendChild(tbody);
            container.appendChild(table);
        }

        async function loadRois() {
            if (!currentSource) {
                rois = [];
                currentPoints = [];
                drawAllRois();
                return;
            }
            const res = await fetch(`/load_roi/${encodeURIComponent(currentSource)}`);
            const data = await res.json();
            rois = data.rois.map((r, idx) => {
                let pts = r.points;
                if (!pts && "x" in r && "y" in r && "width" in r && "height" in r) {
                    pts = [
                        { x: r.x, y: r.y },
                        { x: r.x + r.width, y: r.y },
                        { x: r.x + r.width, y: r.y + r.height },
                        { x: r.x, y: r.y + r.height }
                    ];
                }
                return {
                    id: r.id ?? String(idx + 1),
                    module: r.module ?? null,
                    points: pts || []
                };
            });
            currentPoints = [];
            drawAllRois();
            renderRoiList();
        }

        function saveAllRois() {
            if (rois.length === 0) {
                alert("No ROI selected.");
                return;
            }
            if (!confirm("Save all ROIs?")) return;

            fetch(`/save_roi`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ rois: rois, source: currentSource })
            })
            .then(res => res.json())
            .then(data => {
                alert("Saved to: " + data.filename);
                loadRois();
            });
        }

        function clearAllRois() {
            if (rois.length === 0) {
                alert("No ROI to clear.");
                return;
            }
            if (!confirm("Clear all ROIs?")) return;

            rois = [];
            currentPoints = [];
            drawAllRois();
            renderRoiList();

            fetch(`/save_roi`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ rois: rois, source: currentSource })
            })
            .then(res => res.json())
            .then(data => {
                alert("Cleared. Saved to: " + data.filename);
                loadRois();
            });
        }

        function updateRoiModule(i, module) {
            rois[i].module = module;
        }

        startBtn.addEventListener('click', startStream);
        stopBtn.addEventListener('click', stopStream);
        document.getElementById('saveBtn').addEventListener('click', saveAllRois);
        document.getElementById('clearBtn').addEventListener('click', clearAllRois);

        window.startStream = startStream;
        window.stopStream = stopStream;
        window.saveAllRois = saveAllRois;
        window.clearAllRois = clearAllRois;
        window.updateRoiModule = updateRoiModule;

        window.addEventListener('beforeunload', () => {
            stopStream();
        });

        (async () => {
            await loadSources();
            await loadModules();
            await checkStatus();
        })();
    })();
</script>
{% endblock %}
