# เปรียบเทียบโหมดจัดการ RapidOCR Reader

โมดูล RapidOCR รองรับ 2 รูปแบบการจัดคิวงาน OCR ที่เลือกได้ผ่านตัวแปรแวดล้อม
`RAPIDOCR_WORKER_MODE`

| ค่า | คำอธิบาย |
| --- | --- |
| `executor` (ค่าเริ่มต้น) | ใช้ `ThreadPoolExecutor` เปิด worker ได้หลายเธรด แต่ละเธรดถือ RapidOCR reader ของตัวเอง |
| `lock` | ใช้ผู้อ่าน RapidOCR เพียงตัวเดียวแล้วล็อกให้ทำงานทีละคำขอ (เหมือนโค้ดเวอร์ชันก่อนหน้า) |

## ด้านประสิทธิภาพ

| สถานการณ์ | ThreadPoolExecutor (`executor`) | Lock (`lock`) |
| --- | --- | --- |
| งานขนานพร้อมกันหลาย ROI | เร็วกว่า เพราะทำ OCR พร้อมกันได้หลายเธรดโดยไม่ต้องรอคิวเดียว | ช้ากว่า เนื่องจากทุกคำขอต้องรอให้ OCR ตัวเดียวว่าง |
| งานทีละ ROI / ระบบ Single-thread | มีโอเวอร์เฮดเพิ่มจากการส่งงานผ่าน executor แต่ต่างเพียงหลักมิลลิวินาที | เร็วกว่าเล็กน้อยเพราะเรียก OCR ตรง ๆ ไม่มีโอเวอร์เฮด |
| การใช้ CPU/GPU | กระจายโหลดได้ดีกว่า โดยเฉพาะเมื่อมี GPU หลายคำขอ | โหลดกระจุกที่เธรดเดียว อาจใช้ GPU/CPU ได้ไม่เต็มที่ |
| ความหน่วง (Latency) | น้อยกว่าหากมีงานรอคิวหลายคำขอ เพราะไม่ต้องต่อคิว | น้อยกว่าในกรณีคำขอน้อยมาก (ไม่มีการแข่งขัน) |
| ความเสถียรของผลลัพธ์ | เท่ากัน เพราะแต่ละ reader มีสำเนาภาพของตัวเองก่อนเข้า RapidOCR | เท่ากัน (อ่านทีละคำขอ) |

สรุป:

* หากมีการประมวลผล ROI พร้อมกันหลายตัวหรือเรียก RapidOCR จากหลายเธรด ให้ใช้โหมด `executor`
  เพื่อเพิ่ม Throughput และลดเวลารอคิว
* หากระบบเรียก RapidOCR ทีละคำขอเท่านั้น (เช่น pipeline เดียว) และต้องการลดโอเวอร์เฮด สามารถตั้งค่า
  `RAPIDOCR_WORKER_MODE=lock` เพื่อกลับไปใช้รูปแบบเดิมได้

## วิธีวัดผลด้วยตัวเอง

1. ตั้งค่าโหมดที่ต้องการก่อนรัน เช่น
   ```bash
   export RAPIDOCR_WORKER_MODE=executor
   ```
2. เขียนสคริปต์ทดสอบเรียก `process()` หลาย ๆ รอบ แล้วจับเวลาผ่าน `time.perf_counter()`
3. ลองรันทั้งสองโหมดด้วยจำนวนคำขอพร้อมกันต่างกัน (เช่น 1, 2, 4) จะเห็นว่าโหมด `executor`
   มี Throughput เพิ่มขึ้นตามจำนวน worker ที่ตั้งไว้ (`RAPIDOCR_MAX_READERS`) ขณะที่โหมด `lock`
   มี throughput คงที่แต่ latency ต่อคำขอเสถียร

ค่าตั้งต้นของจำนวน worker จะอยู่ระหว่าง 1-4 โดยดูจากจำนวนคอร์ CPU (`os.cpu_count`) หากต้องการกำหนดเองให้ใช้
`RAPIDOCR_MAX_READERS` (ต้องไม่ต่ำกว่า 1) และสามารถตั้งค่า timeout ก่อนถือคิวได้ผ่าน `RAPIDOCR_ACQUIRE_TIMEOUT`
(หน่วยเป็นวินาที กำหนด `<=0` เพื่อไม่จำกัดเวลา)
