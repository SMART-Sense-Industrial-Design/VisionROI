# คำอธิบายการแก้ไขล่าสุด

เอกสารนี้อธิบายการเปลี่ยนแปลงหลักที่ commit `Ensure ffmpeg workers terminate cleanly and auto-reconnect streams`
ได้เพิ่มเข้าไปในระบบ VisionROI เพื่อแก้ปัญหา ffmpeg ค้างและสตรีมไม่กลับมาทำงานที่หน้าเว็บเมื่อกล้องล่ม
แล้วกลับมาภายหลัง

## 1. กลไกบังคับปิดโปรเซส ffmpeg

ไฟล์ [`camera_worker.py`](../camera_worker.py) เพิ่มเมธอดใหม่ `ensure_ffmpeg_gone()`
ซึ่งจะตรวจสอบว่าโปรเซส ffmpeg ที่ผูกกับ `CameraWorker` ยังทำงานอยู่หรือไม่
หากพบว่ายังไม่ปิดจะส่งสัญญาณ `SIGKILL` ไปยัง process group ของ ffmpeg เพื่อให้หยุดทันที
กลไกนี้ถูกเรียกในหลายจุดสำคัญ เช่น

- ขั้นตอนรีสตาร์ท backend (`_restart_backend`) เพื่อให้มั่นใจว่าไม่มี stdout/stderr
  และโปรเซสเก่าค้างอยู่ก่อนจะเปิด ffmpeg ตัวใหม่ขึ้นมา
- ระหว่างจัดการสถานการณ์ที่ไม่มีวิดีโอเข้ามา (`_handle_no_video_data`) ซึ่งอาจเกิดเมื่อกล้องหายไป
  ชั่วคราว ระบบจะรีสตาร์ท backend พร้อมล้าง queue และปิด ffmpeg เก่าทันที

นอกจากนี้ ในไฟล์ [`app.py`](../app.py) ยังเรียกใช้เมธอด `ensure_ffmpeg_gone()`
จากฟังก์ชัน `_safe_stop()` และ `_shutdown_cleanup` เพื่อบังคับปิด ffmpeg
เมื่อระบบถูกสั่งหยุดผ่าน systemd หรือเมื่อ task บางตัวตอบสนองช้า
ส่งผลให้ systemd ไม่พบโปรเซส ffmpeg แขวนหลังสั่ง stop อีกต่อไป

## 2. การบังคับให้ WebSocket สตรีมรีเฟรชเมื่อเฟรมหาย

เพิ่มตัวแปรสภาพแวดล้อม `STREAM_OUTAGE_GRACE` และ `STREAM_OUTAGE_RETRY`
พร้อม state ภายใน `_stream_disconnect_sent` ใน [`app.py`](../app.py)
เมื่อ worker อ่านเฟรมไม่ได้เกินช่วงเวลาที่กำหนด (`STREAM_OUTAGE_GRACE` ค่าเริ่มต้น 3.5 วินาที)
ระบบจะส่งค่า `None` เข้า queue ของ WebSocket เพื่อตัดการเชื่อมต่อฝั่ง client
ทำให้เบราว์เซอร์ปิดสตรีมเดิมและเชื่อมใหม่โดยอัตโนมัติเมื่อกล้องกลับมา

เพื่อลดการส่งสัญญาณถี่เกินไป ระบบจะจดจำเวลาที่เพิ่งส่ง `None`
และรออย่างน้อย `STREAM_OUTAGE_RETRY` วินาที (ค่าเริ่มต้น 1.5 วินาที)
ก่อนจะส่งอีกครั้งหากยังไม่เห็นเฟรมใหม่ วิธีนี้ช่วยให้หน้าเว็บไม่ค้างภาพเก่า
และสามารถกลับมารับภาพสดทันทีที่กล้องออนไลน์อีกครั้ง

## 3. ผลลัพธ์ที่ได้

- systemd สามารถหยุดบริการได้โดยไม่ติดค้าง เนื่องจากไม่มีโปรเซส ffmpeg
  ที่ยังอยู่ใน process group เดิม
- เมื่อกล้องล่มชั่วคราว หน้าเว็บจะรับรู้จากสัญญาณ `None` และรีเชื่อมต่อกับ WebSocket
  โดยอัตโนมัติ หลังกล้องกลับมา ภาพสตรีมจะถูกส่งใหม่โดยไม่ต้องรีเฟรชหน้าเว็บ

ค่าดีฟอลต์ของ `STREAM_OUTAGE_GRACE` และ `STREAM_OUTAGE_RETRY` สามารถปรับได้ผ่าน
Environment variable หากต้องการความหน่วงที่ต่างออกไปตามสภาพกล้องหรือเครือข่าย
