# ทำไม RapidOCR อ่าน ROI เดิมซ้ำแล้วผลไม่เหมือนเดิม?

เมื่อตัด ROI จากวิดีโอเฟรมด้วยโค้ดประมาณนี้

```python
roi = frame[y1:y2, x1:x2]
text, _ = rapid_ocr(roi)
```

`roi` ไม่ได้เป็นสำเนาของภาพจริง ๆ แต่เป็น *view* ที่แชร์บัฟเฟอร์ข้อมูลร่วมกับตัวแปร `frame` (นี่เป็นพฤติกรรมปกติของ NumPy/OpenCV เมื่อทำ slice แบบนี้)

ลูปถัดไปตัวแปร `frame` จะถูกแทนที่ด้วยเฟรมใหม่ ทำให้ข้อมูลในบัฟเฟอร์เปลี่ยนตามไปด้วย `roi` จึงเปลี่ยนโดยอัตโนมัติ ถึงแม้เรายังอ้างถึงตัวแปรเดิมอยู่ ผลลัพธ์ OCR จึงไม่นิ่ง เพราะ RapidOCR ได้ภาพใหม่ทุกครั้ง

## วิธีแก้

สร้างสำเนาจริงของ ROI ก่อนส่งเข้า OCR

```python
roi = frame[y1:y2, x1:x2].copy()
text, _ = rapid_ocr(roi)
```

`.copy()` จะสร้างอาร์เรย์ใหม่ที่ก๊อปปี้ค่าพิกเซล ณ เฟรมปัจจุบันไว้ทั้งหมด ดังนั้น RapidOCR จะเห็นภาพเดียวกับที่ตาเราเห็นในรอบนั้น แม้เฟรมถัดไปจะถูกอ่านเข้ามาแล้วข้อมูลใน `frame` เปลี่ยนไปก็ตาม หรือถ้าใช้โค้ดอื่นที่ส่ง ROI เข้า thread/background ก็ต้องสำเนาภาพให้เรียบร้อยก่อน เพราะ view ที่แชร์บัฟเฟอร์จะเปลี่ยนตามต้นฉบับเสมอ นอกจากนี้ในโค้ดหลักยังมีการล็อกไม่ให้ RapidOCR ทำงานพร้อมกันหลายเธรดและบังคับให้ภาพเป็น contiguous ก่อนเข้าโมดูลเพื่อป้องกันผล OCR แกว่งเมื่อมีคำขอพร้อมกันหลายคำขอ ปัจจุบัน `_prepare_frame_for_reader` ในโมดูล `rapid_ocr` จะตรวจสอบให้อัตโนมัติว่าภาพยังแชร์บัฟเฟอร์กับเฟรมต้นทางหรือไม่ **รวมถึงกรณีที่อาร์เรย์ไม่มี `owndata` (เช่น ได้มาจาก `np.frombuffer`)** และจะ `copy()` ให้เองหากจำเป็น แต่สำหรับสคริปต์ที่เรียก RapidOCR โดยตรงยังคงควรสำเนาภาพก่อนเสมอเพื่อความชัวร์

## เช็กได้อย่างไรว่าเป็นเพราะ view?

1. ลองพิมพ์ `roi.base is frame` (หรือใช้ `np.shares_memory`) จะพบว่าค่าขึ้น `True`
2. ถ้าพิมพ์ `id(roi.data)` แล้ววนลูปหลายรอบจะได้ค่าเดียวกัน แสดงว่าแชร์บัฟเฟอร์อยู่
3. เมื่อใช้ `.copy()` จะได้ `roi.base is None` และ `id(roi.data)` เปลี่ยน หมายถึงมีสำเนาใหม่จริง ๆ

สรุป: ให้สร้างสำเนาของ ROI ทุกครั้งก่อนส่งเข้า RapidOCR หากต้องการผลลัพธ์ OCR เดิมซ้ำได้

## แล้วทำไมผลลัพธ์ในหน้า Inference ยังเป็น "-" อยู่?

ไอคอน "-" ใน UI หมายถึงรอบล่าสุดไม่ได้ส่งข้อความกลับมา (ฟิลด์ `text` เป็นค่าว่างหรือ `None`). ฝั่ง RapidOCR จะเขียนค่าที่อ่านได้ลง `last_ocr_results` ทุกครั้ง แม้จะเป็นสตริงว่างก็ตาม ดังที่เห็นใน `_run_ocr_async()`【F:inference_modules/rapid_ocr/custom.py†L552-L578】 เมื่อ API ส่งผลลัพธ์ออกมา ส่วนหน้าเว็บจะเช็กค่าที่ได้รับและถ้าไม่ได้ข้อความจะโชว์เป็น "ข้อความ: -"【F:templates/partials/inference_page_content.html†L659-L667】

ดังนั้นแม้ ROI และภาพจะเหมือนเดิม แต่ถ้ารอบใด RapidOCR ตรวจไม่เจอข้อความ (เช่น confidence ต่ำเกิน threshold หรือมี noise) ระบบก็จะเก็บค่าเป็นสตริงว่าง และ UI จึงแสดงเป็น "-" เพื่อบอกว่าเฟรมล่าสุดไม่มี text ให้รายงาน หากต้องการให้เห็นผลลัพธ์เดิม สามารถดูจาก log หรือ `last_ocr_results` ก่อนหน้าที่ไม่ใช่ค่าว่างได้ หรือปรับ ROI/ภาพให้คมชัดขึ้นเพื่อลดโอกาสที่รอบใหม่จะว่างเปล่า

### ค่า confidence (`text_score`) ปัจจุบัน

- RapidOCR เดิมมีค่า threshold ตั้งต้น `Global.text_score = 0.5` ตามไฟล์ `config.yaml` ของแพ็กเกจ【F:docs/rapidocr_text_score_default.md†L5-L8】
- ภายใน VisionROI ปัจจุบันบังคับ override ให้เป็น `0.3` ทุกครั้งที่สร้าง reader เพื่อให้ตัวอ่านยอมรับข้อความที่ความมั่นใจต่ำลงและลดกรณี UI แสดง "-"【F:inference_modules/rapid_ocr/custom.py†L37-L80】
